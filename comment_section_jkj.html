<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‚´ë ¤ì¡° ë°©ëª…ë¡</title>
  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <!-- CSS -->
  <link rel="stylesheet" href="./stylesheet/comment_section.css" />
  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- ì•„ì´ì½˜ -->
  <script src="https://kit.fontawesome.com/49be96d31f.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="./stylesheet/nav.css" />


  <script type="module">

    //ì·¨ì†Œ ëˆ„ë¥´ë©´ ë‹¤ì‹œ comment ì…ë ¥ì°½ ìˆ¨ê¸°ê¸°
    $("#cancell").click(async function () {
      $('.mycommentgbox').hide();
    });

    // Firebase SDK ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { collection, addDoc, setDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Firebase êµ¬ì„± ì •ë³´ ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBCQnr4yIn-M8nJVTlLocbN8KIvFoMrzWQ",
      authDomain: "team-help-783b6.firebaseapp.com",
      projectId: "team-help-783b6",
      storageBucket: "team-help-783b6.appspot.com",
      messagingSenderId: "488622332237",
      appId: "1:488622332237:web:0adf9af9c955e644263f04",
      measurementId: "G-1KMBNSPH2M",
    };
    // Firebase ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let backColor;

    //ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    let today = new Date();
    let year = today.getFullYear();
    let month = today.getMonth() + 1;
    let date = today.getDate();
    let hour = today.getHours();
    let minutes = today.getMinutes();
    let seconds = today.getSeconds();

    // id ë‚ ì§œ ì •ë³´
    let date_id = `${year}${("00" + month.toString()).slice(-2)}${(
      "00" + date.toString()
    ).slice(-2)}${hour}${minutes}${seconds}`;

    //ì €ì¥
    $("#sav").click(async function () {
      const color_list = [
        "#8ABDD1",
        "#8AD1CF",
        "#8AA7D1",
        "#FFD5C2",
        "#FFCAC2",
      ];

      backColor = color_list[Math.floor(Math.random() * color_list.length)];
      let name = $("#inp_name").val();
      let text = $("#inp_txt").val();

      // ë‚´ìš© ì…ë ¥ í™•ì¸
      if (name == "" && text == "") {
        alert("ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤");
        return;
      } else if (name == "") {
        alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      } else if (text == "") {
        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      }

      let check = confirm("ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (check === false) {
        return;
      }

      let password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ì–´ì£¼ì„¸ìš”.");

      //ì·¨ì†Œ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
      if(password == null) {
        return;
      }
      
      //ë¹„ë°€ë²ˆí˜¸ ì•ˆ ì…ë ¥ í–ˆì„ ë•Œ
      if(password == '') {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” !")
      }else { //ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë˜ì—ˆì„ ë•Œ ì €ì¥

        await setDoc(doc(db, "comments", "id" + date_id), {
        name: name,
        text: text,
        backColor: backColor,
        today: today,
        date_id: date_id,
        password: password
      });

      location.reload();

      }


    });

    let docs = await getDocs(collection(db, "comments"));
    docs.forEach((doc) => {
      let row = doc.data();
      let name = row["name"];
      let text = row["text"];
      let backColor = row["backColor"];
      let today = row["today"];
      let date_id = row["date_id"];
      let temp_html = `<div class="box" data-comment-id=${doc.id} style="background-color: ${backColor};">
        <div class="nickname-btn-container">
          <div class="nickname">${name}</div>
          <div class="btns">
          <button type="button" class="btn UDbtn del" style="background-color: rgb(221, 221, 221);">ì‚­ì œ</button>
          <button type="button" class="btn UDbtn ins" style="background-color: rgb(221, 221, 221);">ìˆ˜ì •</button>
          </div>
        </div>
        <div class="content">${text}</div>
        <div hidden>${today}</div>
      </div>`;

      $("#text_container").append(temp_html);
    });

    //ì½”ë©˜íŠ¸ ì‚­ì œë²„íŠ¼ í´ë¦­ì‹œ
    $(document).on("click", ".del", async function () {

      //id ê°€ì ¸ì˜¤ê¸°
      let commentID = $(this).closest(".box").attr("data-comment-id");

      let password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ì–´ì£¼ì„¸ìš”.");

      if(password == null) {
        return;
      }

      let truepassword;

      //DBì—ì„œ id ê°’ì— ë§ëŠ” íŠ¹ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const q = query(
        collection(db, "comments"),
        where('date_id', '==', commentID.substring(2))
      );
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((el) => {
        truepassword= el.data().password;
      });

      if(password != truepassword) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤ !");
        return;
      }

      let check = confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (check === true) {
        try {
          await deleteDoc(doc(db, "comments", commentID));
          $(this).closest(".box").remove();
        } catch (error) {
          console.error("Error deleting document: ", error);
        }
      }
    });


    //ì½”ë©˜íŠ¸ ìˆ˜ì •ë²„íŠ¼ í´ë¦­ì‹œ
    $(".ins").click(async function () {

      //id ê°€ì ¸ì˜¤ê¸°
      let commentID = $(this).closest(".box").attr("data-comment-id");

      let password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì ì–´ì£¼ì„¸ìš”.");
      
      if(password == null) {
        return;
      }

      let truepassword;

      //DBì—ì„œ id ê°’ì— ë§ëŠ” íŠ¹ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const q1 = query(
        collection(db, "comments"),
        where('date_id', '==', commentID.substring(2))
      );
      const querySnapshot1 = await getDocs(q1);

      querySnapshot1.forEach((el) => {
        truepassword= el.data().password;
      });

      if(password != truepassword) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤ !");
        return;
      }

      //DBì—ì„œ id ê°’ì— ë§ëŠ” íŠ¹ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const q2 = query(
        collection(db, "comments"),
        where('date_id', '==', commentID.substring(2))
      );
      const querySnapshot2 = await getDocs(q2);

      let old_text;
      let old_name;

      querySnapshot2.forEach((el) => {
        old_name = el.data().name;
        old_text = el.data().text;
      });

      let new_name = prompt("ìˆ˜ì • í•  ë‹‰ë„¤ì„ì„ ì ì–´ì£¼ì„¸ìš”.", old_name);
      let new_text = prompt("ìˆ˜ì • í•  í…ìŠ¤íŠ¸ë¥¼ ì ì–´ì£¼ì„¸ìš”.", old_text);


      if (new_name !== null && new_text) {
        //ê°’ ì—…ë°ì´íŠ¸
        const docRef = doc(db, "comments", commentID);

        // Set the "capital" field of the city 'DC'
        await updateDoc(docRef, {
          name: new_name,
          text: new_text
        });

      } else if (new_name !== null) {
        const docRef = doc(db, "comments", commentID);
        await updateDoc(docRef, {
          name: new_name,
          text: old_text
        });
      } else if (new_text !== null) {
        const docRef = doc(db, "comments", commentID);
        await updateDoc(docRef, {
          name: old_name,
          text: new_text
        });
      }

      location.reload();

    });

  </script>

  <script src="./comment_section.js" defer></script>
</head>

<body>
  <div class="page-header">
    <a id="menu-icon" class="menu-icon">
      <i class="fa fa-bars"></i>
    </a>
    <div id="navigation-bar" class="Logo">
      <li>
        <a href="./index.html" class="active">
          <i class="fa-solid fa-house"></i></a>
      </li>
      <div id="left_btn">
        <a href="./comment_section_jkj.html">ë°©ëª…ë¡</a>
        <a href="./team_section.html">íŒ€ì†Œê°œ</a>
      </div>
    </div>
    <div class="nav">
      <a href="./personal/jw.html">ì´ì§€ìš°</a>
      <a href="./personal/sy.html">ê¶Œìˆ˜ì—°</a>
      <a href="./personal/my.html">ë°•ë¯¼ì˜</a>
      <a href="./personal/hw.html">ì´í˜„ìš±</a>
      <a href="./personal/kj.html">ì¥ê²½ì§„</a>
    </div>
  </div>
  <div class="titlebox">
    <div>
      <h2 class="title">ì‚´ë ¤ì¡° ë°©ëª…ë¡ âœï¸</h2>
    </div>
    <div class="subtitle">
      <h4>ë°˜ê°‘ìŠµë‹ˆë‹¤ í•œë§ˆë””ì”© ë‚¨ê²¨ì£¼ì„¸ìš”!</h4>
    </div>
    <div class="mycommentgbox" id="commentgbox">
      <div class="form-floating">
        <input type="name" class="form-control" id="inp_name" maxlength="10" />
        <label for="floatingInput">ë‹‰ë„¤ì„ :</label>
      </div>
      <div class="form-floating">
        <input type="text" class="form-control" id="inp_txt" maxlength="50" />
        <label for="floatingInput">ë‚´ìš© : </label>
      </div>
      <div class="inputbtn">
        <button id="sav" type="button" class="btn">
          ì…ë ¥
        </button>
        <button type="button" id="cancell" class="btn">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
    <div id="text_container" class="comment_box">
      <!-- ì´í•˜ ìƒëµ -->
    </div>
  </div>
  <div class="commentinput">
    <div class="editor">
      <h6 style="margin-top: 40px">ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ë°©ëª…ë¡ì„ ì‘ì„±í•˜ì„¸ìš” ğŸ‘‰</h6>
      <a id="btn_editor" class="new_comment">
        <i class="fa-regular fa-pen-to-square fa-4x"></i></a>
    </div>
  </div>
</body>

</html>